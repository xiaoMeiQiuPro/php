<?php
//                                                              _ooOoo_  
//                                                             o8888888o  
//                                                             88" . "88  
//                                                             (| -_- |)                                
//                                                              O\ = /O                                     鹏
//                                                          ____/`---'\____  
//                                                          . ' \\| |// `.                                  仔
//                                                         / \\||| : |||// \  
//                                                       / _||||| -:- |||||- \                              在
//                                                         | | \\\ - /// | |  
//                                                       | \_| ''\---/'' |_/  |                             此
//                                                        \ .-\__ `-` ___/-. /  
//                                                     ___`. .' /--.--\ `. . __                             拜
//                                                  ."" '< `.___\_<|>_/___.' >'"".  
//                                                 | | : `- \`.;`\ _ /`;.`/ - ` : | |                       上
//                                                   \ \ `-. \_ __\ /__ _/ .-` / /  
//                                           ======`-.____`-.___\_____/___.-`____.-'======                  ！
//                                                              `=---='  
//                                    
//                                           .............................................  
//                                                    佛祖保佑             永无BUG 
//                                            佛曰:  
//                                                    写字楼里写字间，写字间里程序员；  
//                                                    程序人员写程序，又拿程序换酒钱。  
//                                                    酒醒只在网上坐，酒醉还来网下眠；  
//                                                    酒醉酒醒日复日，网上网下年复年。  
//                                                    但愿老死电脑间，不愿鞠躬老板前；  
//                                                    奔驰宝马贵者趣，公交自行程序员。  
//                                                    别人笑我忒疯癫，我笑自己命太贱；  
//                                                    不见满街漂亮妹，哪个归得程序员？ 
namespace Api\Controller;
use Think\Controller;
class IndexController extends Controller {
	public function __construct() {
        parent::__construct();
        
    }

    function jiekou(){
    	$this->display();
    }
   function index(){
     echo  123;
   }

    //用户注册
   	function register(){
   		if(empty($_POST['mobile']) || empty($_POST['name'])){
   			json(405,'手机号用户名必须存在','');
   		}
   		if($_POST['password'] !== $_POST['passwords']){
   			json(401,'密码不一致','');
   		}else{
   			if(empty($_POST['password'])){
   				json(402,'密码不能为空','');
   			}
   		}
   		$end = M('users')->where(array('mobile'=>$_POST['mobile']))->find();
   		if($end){
   			json(406,'此手机号已注册','');
   		}
   		if(!empty($_FILES['image']['tmp_name'])){
            $upload = new \Think\Upload();// 实例化上传类
            $upload->maxSize   =     3145728 ;// 设置附件上传大小
            $upload->exts      =     array('jpg', 'gif', 'png', 'jpeg');// 设置附件上传类型
            $upload->rootPath  =     './Uploads/'; // 设置附件上传根目录
            $upload->savePath  =     '/touxiang/'; // 设置附件上传（子）目录
            // 上传文件 
            $info   =   $upload->upload();
            if(!$info) {// 上传错误提示错误信息
                    json(404,$upload->getError(),'');
                    // $this->error($upload->getError());
            }else{// 上传成功
                    // $this->success('上传成功！');
                    foreach($info as $file){  
                        // echo json_encode($file);die;
                    $touxiang = $file['savepath'].$file['savename'];//头像路径


                }
            }
        }else{
            // json(403,'没有上传头像','');
          $touxiang = '';
        }
        $integral = M('config')->where(array('name'=>'reg_integral'))->find();
        if(!$integral){
          $jifen = 0;
        }else{
          $jifen = $integral['value'];
        }
   		$user = M('users')->add(array(
   				'mobile'=>$_POST['mobile'],
   				'password'=>md5($_POST['password']),
   				'name'=>$_POST['name'],
   				'head_pic'=>$touxiang,
          'pay_points'=>$jifen
   			));
   		if($user){
   			json(200,'注册成功','');
   		}else{
   			json(400,'注册失败','');
   		}
   	}


   	//登录
   	function login(){
   		$post = array(
   				'mobile'=>$_POST['mobile'],
   				'password'=>md5($_POST['password'])
   			);
      $res = M('users')->where($post)->find();
      if(!$res){
        json(201,'账号或密码错误','');
      }

      $arr = array(
          'user_id'=>$res['user_id'],
          'pay_points'=>$res['pay_points']
        );
      json(200,'登录成功',$arr);
   	}

    //首页
    function index(){
      //轮播图
      $ad = M('ad')->where(array('enabled'=>'1'))->select();
      foreach ($ad as $key => $value) {
        # code...
        $value['ad_code'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['ad_code'];
        $array[] = $value;
      }
      //今日推荐
      // $pro = M('goods')->where(array('is_recommend'=>'1'))->limit(6)->field('original_img,goods_name,shop_price')->select();
      // echo json_encode($pro);
      $pro = M('goods')->where(array('is_recommend'=>'1'))->limit(6)->field('goods_id,original_img,goods_name,market_price,shop_price,prom_type,prom_id')->select();
      // echo json_encode($pro);
      $arr = array();
      foreach ($pro as $key => $value) {
        $value['original_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['original_img'];
        # code...
        if($value['prom_type'] != 0){
          $prom = M('prom_goods')->where(array('id'=>$value['prom_id']))->field('expression')->find();
          $prom_price = $value['shop_price'] - $prom['expression'];
        }else{
          $prom_price = $value['shop_price'];
        }
        $value['prom_price'] = $prom_price;
        $arr[] = $value;
      }

      $content = array(
          'ad'=>$array,
          'recommend'=>$arr
        );
      json(200,'返回成功',$content);
    }


    //首页今日推荐->全部  分类商品  type = 2  （prom_type = 5为热销）   （prom_type=1 限时抢购）  （prom_type=3 促销）
    function all_recommend(){
      // echo json_encode($_POST);die;
      if($_POST['type'] == 2){
        if(empty($_POST['cat_id'])){
          // json(201,'分类id不存在','');
          // $cat_id = $_POST['cat_id'];
          if($_POST['prom_type'] == 5){
            $where = array(
                // 'cat_id'=>$cat_id,
                'is_hot'=>'1'
              );
          }else{
            $where = array(
                // 'cat_id'=>$cat_id,
                'prom_type'=>$_POST['prom_type']
              );
          }
        }else{
          $cat_id = $_POST['cat_id'];
          if($_POST['prom_type'] == 5){
            $where = array(
                'cat_id'=>$cat_id,
                'is_hot'=>'1'
              );
          }else{
            $where = array(
                'cat_id'=>$cat_id,
                'prom_type'=>$_POST['prom_type']
              );
          }
          // if(empty(var))
          // $prom_type = $_POST['prom_type'];
        }
        // var_dump($where);die;
        if($_POST['xiaoliang'] == 1){
          $order = 'sales_sum desc';
        }else if($_POST['price'] == 'desc'){
          $order = 'shop_price desc';
        }else if($_POST['price'] == 'asc'){
          $order = 'shop_price asc';
        }
        // echo json_encode($_POST);die;
        if($order){
          // echo 1;die;
          $pro = M('goods')->where($where)->order($order)->limit($_POST['page'],$_POST['number'])->field('goods_id,original_img,goods_name,market_price,shop_price,prom_type,prom_id')->select();
        }else{
          // echo 2;die;
          $pro = M('goods')->where($where)->limit($_POST['page'],$_POST['number'])->field('goods_id,original_img,goods_name,market_price,shop_price,prom_type,prom_id')->select();
        }
        
      }else{
        $pro = M('goods')->where(array('is_recommend'=>'1'))->limit($_POST['page'],$_POST['number'])->field('goods_id,original_img,goods_name,market_price,shop_price,prom_type,prom_id')->select();
      }

      $arr = array();
      foreach ($pro as $key => $value) {
        # code...
        $prom = M('prom_goods')->where(array('id'=>$value['prom_id']))->field('expression')->find();

        if($prom['type'] == 0){
          $shu = $res['expression'] / 100;
          $value['prom_price'] = $value['shop_price'] * $shu;
        }else if($res['type'] == 1){
          $value['prom_price'] = $value['shop_price']-$res['expression'];
        }else if($res['type'] == 3){
          $value['prom_price'] = $value['shop_price'];
        }


        // if($value['prom_type'] != 0){
        //   $prom = M('prom_goods')->where(array('id'=>$value['prom_id']))->field('expression')->find();
        //   $prom_price = $value['shop_price'] - $prom['expression'];
        // }else{
        //   $prom_price = $value['shop_price'];
        // }
        // $value['prom_price'] = $prom_price;
        $value['original_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['original_img'];
        $arr[] = $value;
      }


      json(200,'返回成功',$arr);
    }

    //商品详情
    function goods_info(){
      $id = I('goods_id');
      if(!$id){
        json(201,'id不存在','');
      }
      $goods = M('goods')->where(array('goods_id'=>$id))->find();
      unset($goods['goods_content']);
      if($value['prom_type'] != 0){
        $prom = M('prom_goods')->where(array('id'=>$goods['prom_id']))->select('expression')->find();
        $goods['prom_price'] = $value['shop_price'] - $prom['expression'];
      }else{
        $goods['prom_price'] = $goods['shop_price'];
      }

      $store =  M('user_store')->where(array('id'=>$goods['store_id']))->field('store_img,store_name')->find();
      $goods['store_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$store['store_img'];
      $goods['original_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$goods['original_img'];
      $goods['store_name'] = $store['store_name'];
      // $img = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.'/'.$end['img_url'];
      $img = M('goods_images')->where(array('goods_id'=>$id))->select();
      foreach ($img as $key => $value) {
        # code...
        $value['image_url'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['image_url'];
        $arr[] = $value;
      }

      $img_info = M('goods_info')->where(array('goods_id'=>$id))->select();
      foreach ($img_info as $key => $value) {
        # code...
        $value['image'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['image'];
        $array[] = $value;
      }
      if(empty($array)){
        $array = array();
      }

      $goods_type = M('spec_goods_price')->where(array('goods_id'=>$id))->find();
      $acc = explode('_',$goods_type['key']);
      foreach ($acc as $key => $value) {
        # code...
        $rr= M('spec_item')->where(array('id'=>$value))->field('spec_id')->find();
        $spec[] = $rr['spec_id'];
      }
      // echo json_encode($spec);die;

      foreach ($spec as $key => $value) {
        # code...
        $sp[] = M('spec')->where(array('id'=>$value))->field('id,name')->find();
        
        
      }
      foreach ($sp as $key => $value) {
          # code...
          $sp[$key]['spec_item'] = M('spec_item')->where(array('spec_id'=>$value['id']))->select();
        }

      //收藏状态
      $goods_collect = M('goods_collect')->where(array('user_id'=>I('user_id'),'goods_id'=>$id))->find();
      if($goods_collect){
        $collect = '1';
      }else{
        $collect = '0';
      }

      $spec_img = M('spec_image')->where(array('goods_id'=>$id))->select();
      foreach ($spec_img as $key => $value) {
        # code...
        if(!empty($value['src'])){
        $value['src'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['src'];

      }else{
        $value['src'] = '';
        
      }
      $spec_image[] = $value;
      }
      $comment = M('comment')->where(array('goods_id'=>$id))->limit(1)->field('order_goods_id,content,user_id')->select();
      $quan = M('comment')->where(array('goods_id'=>$id))->field('order_goods_id,content,user_id,is_img,img')->select();
      foreach ($quan as $k5 => $v5) {
        # code...
      }
      if($quan){
        $shu = $k5 + 1;
      }else{
        $shu = 0;
      }
      foreach ($comment as $key => $value) {
        # code...
        $order_goods = M('order_goods')->where(array('rec_id'=>$value['order_goods_id']))->field('spec_key_name')->find();
        $value['spec_key_name'] = $order_goods['spec_key_name'];
        $user = M('users')->where(array('user_id'=>$value['user_id']))->field('head_pic,name')->find();
        $value['touxiang'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$user['head_pic'];
        $value['user_name'] = $user['name'];

        if($value['is_img'] == 1){
          $img = explode(',',$value['img']);
          foreach ($img as $k => $v) {
            # code...
            $imag[] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$v;
          }
          $value['image'] = $imag;
        }else{
          $value['image'] = array();

        }
        $value['all'] = $shu;
        $user_info[] = $value;
      }


      $goods['collect'] = $collect;

      if(empty($user_info)){
        $user_info = array();
      }
      $content = array(
          'goods'=>$goods,
          'img'=>$arr,
          'img_info'=>$array,
          'item'=>$sp,
          'spec_img'=>$spec_image,
          'comment'=>$user_info
        );
      json(200,'返回成功',$content);
    }

    //分类
    function goods_category(){
      if($_POST['parent_id'] == 0){
        $arr = M('goods_category')->where(array('parent_id'=>'0','is_show'=>'1'))->field('id,name,mobile_name,parent_id')->select();
      }else{
        $res = M('goods_category')->where(array('parent_id'=>$_POST['parent_id'],'is_show'=>'1'))->field('id,name,mobile_name,parent_id')->select();
          foreach ($res as $key => $value) {
            # code...
            $zi = M('goods_category')->where(array('parent_id'=>$value['id'],'is_show'=>'1'))->field('id,name,mobile_name,parent_id,image')->select();
            foreach ($zi as $k => $v) {
              # code...
              $zi[$k]['image'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$v['image'];
            }
            $value['ziji'] = $zi;
            $arr[] = $value;
          }
      }
      
      json(200,'返回成功',$arr);
    }

    function goods_category_all(){
      $arr = M('goods_category')->where(array('is_show'=>'1'))->field('id,name,mobile_name,parent_id,level')->select();
      
      $this->category_date($arr,$id=0);
    }

    function category_date($arr,$id){
      // echo 1;die;
      $fuji = array();
            foreach ($arr as $key => $value) {
              # code...
              if($value['parent_id'] == $id){
                $fuji[] = $value;
              }
            }
            // echo json_encode($fuji);die;
        foreach ($fuji as $k => $v) {
          # code...
          $ziji = $this->category_date($arr,$v['parent_id']);
          if($ziji){
            $fuji[$k]['ziji'] = $ziji;
          }
        }
        echo json_encode($fuji);
    }

    //店铺
    function store(){
      $user_id = $_POST['user_id'];
      $id = $_POST['store_id'];
      if(!$id){
        json(201,'id不存在','');
      }
      $res = M('user_store')->where(array('id'=>$id))->find();
      $res['store_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$res['store_img'];
      $pro = M('goods')->where(array('store_id'=>$id))->limit($_POST['page'],$_POST['number'])->field('goods_id,original_img,goods_name,market_price,shop_price,prom_type,prom_id')->select();
      $arr = array();
      foreach ($pro as $key => $value) {
        # code...
        if($value['prom_type'] != 0){
          $prom = M('prom_goods')->where(array('id'=>$value['prom_id']))->field('expression')->find();
          $prom_price = $value['shop_price'] - $prom['expression'];
        }else{
          $prom_price = $value['shop_price'];
        }
        $value['prom_price'] = $prom_price;
        $value['original_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['original_img'];
        $arr[] = $value;
      }
      $foll = M('follow_store')->where(array('user_id'=>$user_id,'store_id'=>$store_id))->find();
      if($foll){
        $follow = '1';
      }else{
        $follow = '0';

      }
      $res['guanzhu'] = $follow;
      $content = array(
          'store'=>$res,
          'goods'=>$arr
          // 'guanzhu'=>$follow
        );

      json(200,'返回成功',$content);

    }

    //关注取消店铺
    function follow(){
      if(empty($_POST['user_id']) || empty($_POST['store_id'])){
        json(201,'用户未登录或店铺不存在','');
      }
      $post = array(
          'user_id'=>$_POST['user_id'],
          'store_id'=>$_POST['store_id']
        );

      $res = M('follow_store')->where($post)->find();
      if($res){
        M('follow_store')->where($post)->delete();
        M('user_store')->where(array('id'=>$post['store_id']))->setDec('follow');

        json(200,'取消关注成功','');
      }else{
        M('follow_store')->add($post);
        // $follow = M('user_store')

        M('user_store')->where(array('id'=>$post['store_id']))->setInc('follow');
        json(200,'关注成功','');
      }

    }


    //限时秒杀
    function seckill(){
      $time = $_POST['time'];
      // if($time = 10){
        $time_data = strtotime(date('Y-m-d',time())) + 3600 * $time;
        $time_data = date('Y-m-d H:i:s',$time_data);
        // echo $time_data;
      // }
      $res = M('goods_seckill')->where(array('start_time'=>$time_data))->find();
      $pro = M('goods')->where(array('seckill_id'=>$res['id']))->limit($_POST['page'],$_POST['number'])->field('goods_id,original_img,goods_name,market_price,shop_price,activity_sell,activity_stock')->select();
      foreach ($pro as $key => $value) {
        # code...
        $value['original_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['original_img'];
        if($res['type'] == 0){
          $shu = $res['expression'] / 100;
          $value['prom_price'] = $value['shop_price'] * $shu;
        }else if($res['type'] == 1){
          $value['prom_price'] = $value['shop_price']-$res['expression'];
        }else if($res['type'] == 3){
          $value['prom_price'] = $value['shop_price'];
        }
        $arr[] = $value;
      }
      if(!$res){
      json(201,'返回成功',$arr);

      }
      json(200,'返回成功',$arr);
    }

    //选择属性返回商品价格库存
    function return_spec(){
      $key = $_POST['key'];
      $res = M('spec_goods_price')->where(array('key'=>$key,'goods_id'=>$_POST['goods_id']))->find();

      json(200,'成功',$res);
    }

    //下单
    function add_order(){
      if(empty($_POST['goods_id'])){
        json(201,'商品不存在','');
      }
      if(empty($_POST['user_id'])){
        json(202,'用户未登录','');
      }
      $res = M('spec_goods_price')->where(array('key'=>$_POST['key'],'goods_id'=>$_POST['goods_id']))->find();
      if($res['store_count'] <= 0 || $_POST['goods_num'] > $res['store_count']){
        json(203,'库存不足','');
      }
      
      $goods = M('goods')->where(array('goods_id'=>$_POST['goods_id']))->find();

      if($goods['prom_type'] != 0){
        if($_POST['goods_num'] > $goods['activity_stock']){
          json(204,'活动库存不足','');
        }
        //限时秒杀
        if($goods['prom_type'] == 6){
          $seckill = M('goods_seckill')->where(array('id'=>$goods['seckill_id']))->find();
            if($seckill['type'] == 0){
              $shu = $seckill['expression'] / 100;
              $prom_price = $res['price'] * $shu;
            }else if($seckill['type'] == 1){
              $prom_price = $res['price']-$seckill['expression'];
            }else if($seckill['type'] == 3){
              $prom_price = $res['price'];
            }
            // $goods['prom_id'] = $goods['seckill_id'];
        }else{
          //活动
        $seckill = M('prom_goods')->where(array('id'=>$goods['prom_id']))->find();
            if($seckill['type'] == 0){
              $shu = $seckill['expression'] / 100;
              $prom_price = $res['price'] * $shu;
            }else if($seckill['type'] == 1){
              $prom_price = $res['price']-$seckill['expression'];
            }else if($seckill['type'] == 3){
              $prom_price = $res['price'];
            }
        }

        
      }else{
        //普通
        $prom_price = $res['price'];
      }
      //最终支付价格
      $prom_price = $prom_price * $_POST['goods_num'];
      // echo $prom_price;die;
      if(!empty($_POST['coupon_id'])){
        $list = M('coupon_list')->where(array('id'=>$_POST['coupon_id'],'status'=>'0'))->field('cid')->find();
        $cou = M('coupon')->where(array('id'=>$list['cid']))->find();
        if($cou['condition'] <= $prom_price && $cou['use_start_time'] <= time() && $cou['use_end_time'] >= time()){
          $prom_price = $prom_price - $cou['money'];
          $coupon_id = $_POST['coupon_id'];
          $coupon_price = $cou['money'];
        }else{
          $coupon_id = 0;
          $coupon_price = 0;
        }
      }else{
        $coupon_id = 0;
          $coupon_price = 0;
      }

      $a = substr(str_shuffle(time()),1) * 99;
      $sn = 'Angel'.$a;
      $arr = array(
          'order_sn'=>$sn,
          'user_id'=>$_POST['user_id'],
          'consignee'=>$_POST['consignee'],
          'country'=>$_POST['country'],
          'province'=>$_POST['province'],
          'city'=>$_POST['city'],
          'district'=>$_POST['district'],
          'twon'=>$_POST['twon'],
          'address'=>$_POST['address'],
          'zipcode'=>$_POST['zipcode'],
          'mobile'=>$_POST['mobile'],
          'goods_price'=>$prom_price,
          'shipping_price'=>'0',
          'total_amount'=>$prom_price,
          'order_amount'=>$prom_price,
          'add_time'=>time(),
          'store_id'=>$goods['store_id'],
          'cart_order_sn'=>time(),
          'order_prom_type'=>$goods['prom_type'],
          'coupon_id'=>$coupon_id,
          'coupon_price'=>$coupon_price
        );
      $order_id = M('order')->add($arr);
      if(!empty($_POST['coupon_id'])){
        if($order_id){
          $up_list_cou = M('coupon_list')->where(array('id'=>$_POST['coupon_id']))->save(array(
              'order_id'=>$order_id,
              'use_time'=>time(),
              'status'=>'1'
            ));
        }
      }
      
      if($goods['exchange_integral'] != 0){
        $jifen = $goods['give_integral'];
      }else{
        $jifen = 0;
      }
      $order_goods = M('order_goods')->add(array(
          'order_id'=>$order_id,
          'goods_id'=>$_POST['goods_id'],
          'goods_name'=>$goods['goods_name'],
          'goods_sn'=>$goods['goods_sn'],
          'goods_num'=>$_POST['goods_num'],
          'market_price'=>$goods['market_price'],
          'goods_price'=>$goods['shop_price'],
          'cost_price'=>$goods['cost_price'],
          'spec_key'=>$_POST['key'],
          'spec_key_name'=>$res['key_name'],
          'member_goods_price'=>$prom_price,
          'prom_type'=>$goods['prom_type'],
          'prom_id'=>$goods['prom_id'],
          'give_integral'=>$jifen
        ));
      $this->pay($order_id);
    }

    //代付款  付款
    function order_pay(){
      if($_POST['order_id']){
        $this->pay($_POST['order_id']);
      }else{
        json(201,'订单不存在','');
      }
    }


    //pay支付
    function pay($order_id){
      // echo $order_id;die;
      // $order_id = 1514;
      $order = M('order')->where(array('order_id'=>$order_id))->find();
      // echo json_encode($order);die;
      require_once('./pay/aop/AopClient.php');
      $shu = srand((double)microtime()*1000000);
      $c = new \AopClient;
      $dat = array(
          'app_id'=>'2017010304816030',
          'biz_content'=>json_encode(array(
              'subject'=>'欢迎下次购买',
              'out_trade_no'=>$order['order_sn'],
              'total_amount'=>$order['order_amount'],
              'product_code'=>'QUICK_MSECURITY_PAY'
            )),
          'charset'=>'utf-8',
          'method'=>'alipay.trade.app.pay',
          'notify_url'=>'https://www.baidu.com',
          'sign_type'=>'RSA',
          'timestamp'=>'2014-07-24 03:07:50',
          'version'=>'1.0'
        );
      $data = $c->getSignContent($dat);
      // echo $data;die;
      $res = $c->sign($data);
      // echo json_encode($res);die;
      $i = 0;
      $a = '';
      foreach ($dat as $key => $value) {
        # code...
        if($i == 0){
          $a .= $key.'='.urlencode($value);
        }else{
          $a .= '&'.$key.'='.urlencode($value);
        }
        
      }
      $data = $data.'&sign='.urlencode($res);

      json(200,'签名成功',$data);
    }

    //pay回调
    function pay_notify_url(){
    // file_put_contents("newfilea.txt",json_encode($_POST));
      require_once('./pay/aop/AopClient.php');

      // require_once('application/libraries/pay/aop/AopClient.php');
    // $myfile = fopen("newfile.txt", "w") or die("Unable to open file!");
    // // fwrite($myfile, $_POST);
    // file_put_contents("newfilea.txt",json_encode($_POST));
    $shu = '{"gmt_create":"2017-06-27 16:56:02","charset":"utf-8","seller_email":"liwei_hensatuo@163.com","subject":"\u8d2d\u7269\u8f66","sign":"FxEeFYqkY9dk8jOlXyq0iNqwy27SkRUiZK3IDzVokyskl2rG2vnkAWeVLBYt+3blqTjh+q0ouRs\/73g2KxvhWww6AQyPvYhStfjj+oiWza6su3ITJqGkT7FJu43Y0lFszRAjCsnkeP98VjEkeLuy2KM9rc04A4yp+KcirrhwUsI=","buyer_id":"2088022003197619","invoice_amount":"0.08","notify_id":"6a2ace753502a3210e8ccf144795184kpi","fund_bill_list":"[{\"amount\":\"0.08\",\"fundChannel\":\"ALIPAYACCOUNT\"}]","notify_type":"trade_status_sync","trade_status":"TRADE_SUCCESS","receipt_amount":"0.08","app_id":"2017010304816030","buyer_pay_amount":"0.08","sign_type":"RSA","seller_id":"2088421735959795","gmt_payment":"2017-06-27 16:56:03","notify_time":"2017-06-27 16:56:03","version":"1.0","out_trade_no":"Angel58763475342","total_amount":"0.08","trade_no":"2017062721001004610274477954","auth_app_id":"2017010304816030","buyer_logon_id":"101***@qq.com","point_amount":"0.00"}';
    $_POST = json_decode($shu,true);
    // var_dump($_POST['sign']);die;
    // $_POST = 
    $aop = new \AopClient;
    $aop->alipayrsaPublicKey = 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDMbDuT2JzxTsBDnFgycdKauZZlS3nEqWurKzE2V26joHAEEnqQWqkQCNe/mMJXJszQQoehiJQ3cEOsdP34XpNh2Rg5fLWN436PkoHZbyfcOBk6A3AxGA6bNcDFSpqa7Uxxo6txN3HzsGfEa+Tg1haZy6wjBQYRUrd92QWnidYDgQIDAQAB';
    $public = 'MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDMbDuT2JzxTsBDnFgycdKauZZlS3nEqWurKzE2V26joHAEEnqQWqkQCNe/mMJXJszQQoehiJQ3cEOsdP34XpNh2Rg5fLWN436PkoHZbyfcOBk6A3AxGA6bNcDFSpqa7Uxxo6txN3HzsGfEa+Tg1haZy6wjBQYRUrd92QWnidYDgQIDAQAB';
    // var_dump($_POST);die;
    $result = $aop->rsaCheckV1($_POST, $public, "RSA");
    // var_dump($result);die;
      // if($result) {//验证成功
        // echo 1;die;
      /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      //请在这里加上商户的业务逻辑程序代

      
      //——请根据您的业务逻辑来编写程序（以下代码仅作参考）——
      
        //获取支付宝的通知返回参数，可参考技术文档中服务器异步通知参数列表
      
      //商户订单号
    // file_put_contents("newfile.txt",'1');die;

      $out_trade_no = $_POST['out_trade_no'];

      //支付宝交易号

      $trade_no = $_POST['trade_no'];

      //交易状态
      $trade_status = $_POST['trade_status'];


        if($_POST['trade_status'] == 'TRADE_FINISHED') {

        //判断该笔订单是否在商户网站中已经做过处理
          //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
          //请务必判断请求时的total_amount与通知时获取的total_fee为一致的
          //如果有做过处理，不执行商户的业务程序
            
        //注意：
        //退款日期超过可退款期限后（如三个月可退款），支付宝系统发送该交易状态通知
        }
        else if ($_POST['trade_status'] == 'TRADE_SUCCESS' && $_POST['auth_app_id'] == '2017010304816030' && $_POST['subject'] == '购物车') {
    // file_put_contents("newfile.txt",'1');die;

        //判断该笔订单是否在商户网站中已经做过处理
          //如果没有做过处理，根据订单号（out_trade_no）在商户网站的订单系统中查到该笔订单的详细，并执行商户的业务程序
          //请务必判断请求时的total_amount与通知时获取的total_fee为一致的
          //如果有做过处理，不执行商户的业务程序      
        //注意：
        //付款完成后，支付宝系统发送该交易状态通知
          $up = M('order')->where(array('cart_order_sn'=>$out_trade_no))->save(array('pay_time'=>time(),'pay_status'=>'1','pay_code'=>$trade_no,'pay_name'=>'支付宝'));
          if($up){
            $order = M('order')->where(array('cart_order_sn'=>$out_trade_no))->select();
              foreach ($order as $key => $value) {
                # code...
                $pro = M('order_goods')->where(array('order_id'=>$value['order_id']))->select();
                  foreach ($pro as $k => $v) {
                    # code...
                    // $goods_sun = M('goods')->where(array('goods_id'=>$v['goods_id']))->
                    if($value['order_prom_type'] != '0'){
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setInc('activity_sell',$v['goods_num']);
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setDec('activity_stock',$v['goods_num']);
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setInc('sales_sum',$v['goods_num']);
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setDec('store_count',$v['goods_num']);
                    }else{
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setInc('sales_sum',$v['goods_num']);
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setDec('store_count',$v['goods_num']);
                    }
                    // M('goods')
                  }
                  M('user_store')->where(array('id'=>$value['store_id']))->setInc('sale',$value['order_amount']);
              }
              // M('user_store')->where(array('id'=>$order))
          }
          
          

        echo "success";die;
      


            //请不要修改或删除
        }else if($_POST['trade_status'] == 'TRADE_SUCCESS'  && $_POST['auth_app_id'] == '2017010304816030' && $_POST['subject'] == '欢迎下次购买'){
          $up = M('order')->where(array('order_sn'=>$out_trade_no))->save(array('pay_time'=>time(),'pay_status'=>'1','pay_code'=>$trade_no,'pay_name'=>'支付宝'));
          
          if($up){
            $order = M('order')->where(array('order_sn'=>$out_trade_no))->select();
              // foreach ($order as $key => $value) {
                # code...
                $pro = M('order_goods')->where(array('order_id'=>$order['order_id']))->select();
                  foreach ($pro as $k => $v) {
                    # code...
                    // $goods_sun = M('goods')->where(array('goods_id'=>$v['goods_id']))->
                    if($order['order_prom_type'] != '0'){
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setInc('activity_sell',$v['goods_num']);
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setDec('activity_stock',$v['goods_num']);
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setInc('sales_sum',$v['goods_num']);
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setDec('store_count',$v['goods_num']);
                    }else{
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setInc('sales_sum',$v['goods_num']);
                      M('goods')->where(array('goods_id'=>$v['goods_id']))->setDec('store_count',$v['goods_num']);
                    }
                    // M('goods')
                  }
                  M('user_store')->where(array('id'=>$order['store_id']))->setInc('sale',$order['order_amount']);
              // }
              // M('user_store')->where(array('id'=>$order))
          }
          

          echo "success";die;
        }else if($_POST['trade_status'] == 'TRADE_SUCCESS'  && $_POST['auth_app_id'] == '2017010304816030' && $_POST['subject'] == '报事报修'){
    


          echo "success";die;
        }else if($_POST['trade_status'] == 'TRADE_SUCCESS'  && $_POST['auth_app_id'] == '2017010304816030' && $_POST['subject'] == '余额充值'){
          
          echo "success";die;

        }
      //——请根据您的业务逻辑来编写程序（以上代码仅作参考）——
    // file_put_contents("newfile.txt",'4');die;
            
      echo "fail";
        
    // }else {
    //     //验证失败
    //     echo "fail"; //请不要修改或删除

    // }

    }


    //收藏商品
    function collection(){
      $post = array(
          'user_id'=>$_POST['user_id'],
          'goods_id'=>$_POST['goods_id']
        );
      $res = M('goods_collect')->where($post)->find();
      if($res){
        M('goods_collect')->where($post)->delete();
        json(200,'取消收藏成功','');
      }else{
        $post['add_time'] = time();
        M('goods_collect')->add($post);
        json(200,'收藏成功','');
      }
    }

    //加入购物车
    function add_cart(){
      if(empty($_POST['user_id'])){
        json(201,'没有登录','');
      }
      if(empty($_POST['goods_id'])){
        json(202,'没有选择商品','');
      }
      $goods_id = $_POST['goods_id'];

      $sell_cart = M('cart')->where(array('goods_id'=>$goods_id,'user_id'=>$_POST['user_id'],'spec_key'=>$_POST['key']))->find();
      if($sell_cart){
        M('cart')->where(array('goods_id'=>$goods_id,'user_id'=>$_POST['user_id'],'spec_key'=>$_POST['key']))->setInc('goods_num',$_POST['number']);
        json(200,'加入购物车成功','');
      }

      $goods = M('goods')->where(array('goods_id'=>$goods_id))->find();
      $cart = M('cart')->add(array(
          'user_id'=>$_POST['user_id'],
          'goods_id'=>$goods_id,
          'goods_sn'=>$goods['goods_sn'],
          'goods_name'=>$goods['goods_name'],
          'market_price'=>$goods['market_price'],
          'goods_price'=>$goods['shop_price'],
          'member_goods_price'=>$goods['shop_price'],
          'goods_num'=>$_POST['number'],
          'spec_key'=>$_POST['key'],
          'spec_key_name'=>$_POST['spec_key_name'],
          'add_time'=>time(),
          'store_id'=>$_POST['store_id'],
          'prom_type'=>$_POST['prom_type']
        ));
      if($cart){
        json(200,'加入购物车成功','');
      }
    }

    //返回购物车
    function return_cart(){
      $user_id = $_POST['user_id'];
      $res = M('cart')->where(array('user_id'=>$user_id))->field('store_id')->select();

      foreach ($res as $key => $value) {
        # code...
        $arr[$key][] = $value['store_id'];
      }
      foreach ($arr as $key => $value) {
        # code...
        foreach ($value as $k => $v) {
          # code...
          $acc[] = $v;
        }
      }
      $array = array_unique($acc);
      foreach ($array as $key => $value) {
        # code...
        $ii[$key]['store_id'] = $value;
      }
      // echo json_encode($ii);die;
      foreach ($ii as $key => $value) {
        # code...
        $name = M('user_store')->where(array('id'=>$value['store_id']))->field('store_name,store_img')->find();
        $value['store_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$name['store_img'];

        $value['name'] = $name['store_name'];
        $goods_s = M('cart')->where(array('user_id'=>$user_id,'store_id'=>$value['store_id']))->field('id,goods_id,spec_key,spec_key_name,goods_num,prom_type')->select();

          foreach ($goods_s as $kk => $vv) {
        # code...
        $goods = M('goods')->where(array('goods_id'=>$vv['goods_id']))->find();
        $price = M('spec_goods_price')->where(array('key'=>$vv['spec_key']))->find();

        $goods_s[$kk]['price'] =  $price['price'] * $vv['goods_num'];
        $goods_s[$kk]['num'] = $vv['goods_num'];
        $goods_s[$kk]['prom_type'] = $vv['prom_type'];
        $goods_s[$kk]['name'] = $goods['goods_name'];
        $goods_s[$kk]['time'] = date('Y-m-d',$vv['add_time']);
        $img = M('spec_image')->where(array('goods_id'=>$vv['goods_id']))->select();
        foreach ($img as $ke => $val) {
          # code...
          $val['src'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$val['src'];
          $image[] = $val;
        }
        $goods_s[$kk]['image'] = $image;
      }
        

        $value['goods'] = $goods_s;
        // $store['']
        $pp[] = $value;
      }

      json(200,'返回购物车',$pp);
    }

    //购物车下单
    function cart_order(){
      // $user_id = 1;
      // $goods_num
      // $arr = array(array('goods_id'=>'1','key'=>'11_100_102','goods_num'=>'1','prom_type'=>'3'),array('goods_id'=>'105','key'=>'11_13_100','goods_num'=>'1','prom_type'=>'0'));
      // echo json_encode($arr);die;
      if(empty($_POST['json'])){
        json(207,'商品不存在','');
      }
      $arr = json_decode($_POST['json'],true);
      $b = substr(str_shuffle(time()),1) * 99;
      $cart_order = 'Angel'.$b;
      foreach ($arr as $key => $value) {
        # code...
          $name = M('goods')->where(array('goods_id'=>$value['goods_id']))->find();

        $res = M('spec_goods_price')->where(array('key'=>$value['key'],'goods_id'=>$value['goods_id']))->find();
        if($res['store_count'] <= 0 || $value['goods_num'] > $res['store_count']){
          // echo $value['goods_id'];
          // echo $name['goods_name'];
          json(203,$name['goods_name'].'库存不足','');
        }

        $goods = M('goods')->where(array('goods_id'=>$value['goods_id']))->find();

      if($goods['prom_type'] != 0){
        if($value['goods_num'] > $goods['activity_stock']){
          // $name = M('goods')->where(array('goods_id'=>$value['goods_id']))->field('goods_name')->find();
          json(204,$name['goods_name'].'活动库存不足','');
        }
        //限时秒杀
        if($goods['prom_type'] == 6){

          $seckill = M('goods_seckill')->where(array('id'=>$goods['seckill_id']))->find();
          $start_time = strtotime($seckill['start_time']);
          $end_time = strtotime($seckill['end_time']);
          if($start_time < time() && time() < $end_time){
            if($seckill['type'] == 0){
              $shu = $seckill['expression'] / 100;
              $prom_price = $res['price'] * $shu;
            }else if($seckill['type'] == 1){
              $prom_price = $res['price']-$seckill['expression'];
            }else if($seckill['type'] == 3){
              $prom_price = $res['price'];
            }
          }else{
            // $name = M('goods')->where(array('goods_id'=>$value['goods_id']))->field('goods_name')->find();
            json(205,$name['goods_name'].'已经不能抢购','');
          }
            
        }else{
        $seckill = M('prom_goods')->where(array('id'=>$goods['prom_id']))->find();
            if($seckill['type'] == 0){
              $shu = $seckill['expression'] / 100;
              $prom_price = $res['price'] * $shu;
            }else if($seckill['type'] == 1){
              $prom_price = $res['price']-$seckill['expression'];
            }else if($seckill['type'] == 3){
              $prom_price = $res['price'];
            }
            // echo $prom_price;
        }

        
      }else{
        //普通
        $prom_price = $res['price'];
      }


      $prom_price = $prom_price * $value['goods_num'];

      if(!empty($value['coupon_id'])){
        $list = M('coupon_list')->where(array('id'=>$value['coupon_id'],'status'=>'0'))->field('cid')->find();
        $cou = M('coupon')->where(array('id'=>$list['cid']))->find();
        if($cou['condition'] <= $prom_price && $cou['use_start_time'] <= time() && $cou['use_end_time'] >= time()){
          $prom_price = $prom_price - $cou['money'];
          $coupon_id = $value['coupon_id'];
          $coupon_price = $cou['money'];
        }else{
          $coupon_id = 0;
          $coupon_price = 0;
        }
      }else{
        $coupon_id = 0;
          $coupon_price = 0;
      }

      $qian[] = $prom_price;
      $a = substr(str_shuffle(time()),1) * 99;
      $sn = 'Angel'.$a;
      $zu = array(
          'order_sn'=>$sn,
          'user_id'=>$_POST['user_id'],
          'consignee'=>$_POST['consignee'],
          'country'=>$_POST['country'],
          'province'=>$_POST['province'],
          'city'=>$_POST['city'],
          'district'=>$_POST['district'],
          'twon'=>$_POST['twon'],
          'address'=>$_POST['address'],
          'zipcode'=>$_POST['zipcode'],
          'mobile'=>$_POST['mobile'],
          'goods_price'=>$prom_price,
          'shipping_price'=>'0',
          'total_amount'=>$prom_price,
          'order_amount'=>$prom_price,
          'add_time'=>time(),
          'store_id'=>$goods['store_id'],
          'cart_order_sn'=>$cart_order,
          'order_prom_type'=>$goods['prom_type'],
          'coupon_id'=>$coupon_id,
          'coupon_price'=>$coupon_price
        );

      $order_id = M('order')->add($zu);

      if(!empty($value['coupon_id'])){
        if($order_id){
          $up_list_cou = M('coupon_list')->where(array('id'=>$value['coupon_id']))->save(array(
              'order_id'=>$order_id,
              'use_time'=>time(),
              'status'=>'1'
            ));
        }
      }


      if($goods['exchange_integral'] != 0){
        $jifen = $goods['give_integral'];
      }else{
        $jifen = 0;
      }
      $order_goods = M('order_goods')->add(array(
          'order_id'=>$order_id,
          'goods_id'=>$value['goods_id'],
          'goods_name'=>$name['goods_name'],
          'goods_sn'=>$name['goods_sn'],
          'goods_num'=>$value['goods_num'],
          'market_price'=>$name['market_price'],
          'goods_price'=>$name['shop_price'],
          'cost_price'=>$name['cost_price'],
          'spec_key'=>$value['key'],
          'spec_key_name'=>$res['key_name'],
          'member_goods_price'=>$prom_price,
          'prom_type'=>$name['prom_type'],
          'prom_id'=>$name['prom_id'],
          'give_integral'=>$jifen
        ));

      }
      $money = array_sum($qian);
      // echo $money;
      $this->cart_pay($cart_order,$money);
    }

    function cart_pay($cart_order,$money){

      require_once('./pay/aop/AopClient.php');
      $shu = srand((double)microtime()*1000000);
      $c = new \AopClient;
      $dat = array(
          'app_id'=>'2017010304816030',
          'biz_content'=>json_encode(array(
              'subject'=>'欢迎下次购买',
              'out_trade_no'=>$cart_order,
              'total_amount'=>$money,
              'product_code'=>'QUICK_MSECURITY_PAY'
            )),
          'charset'=>'utf-8',
          'method'=>'alipay.trade.app.pay',
          'notify_url'=>'https://www.baidu.com',
          'sign_type'=>'RSA',
          'timestamp'=>'2014-07-24 03:07:50',
          'version'=>'1.0'
        );
      $data = $c->getSignContent($dat);
      // echo $data;die;
      $res = $c->sign($data);
      // echo json_encode($res);die;
      $i = 0;
      $a = '';
      foreach ($dat as $key => $value) {
        # code...
        if($i == 0){
          $a .= $key.'='.urlencode($value);
        }else{
          $a .= '&'.$key.'='.urlencode($value);
        }
        
      }
      $data = $data.'&sign='.urlencode($res);

      json(200,'签名成功',$data);
    }

    //添加 修改 删除地址
    function add_address(){
      $arr = array(
          'user_id'=>$_POST['user_id'],
          'consignee'=>$_POST['consignee'],
          'email'=>$_POST['email'],
          'country'=>$_POST['country'],
          'province'=>$_POST['province'],
          'city'=>$_POST['city'],
          'district'=>$_POST['district'],
          'twon'=>$_POST['twon'],
          'address'=>$_POST['address'],
          'zipcode'=>$_POST['zipcode'],
          'mobile'=>$_POST['mobile'],
          'is_default'=>$_POST['is_default']
        );
      $post = array_filter($arr);
      if($post['is_default'] == 1){
        M('user_address')->where(array('user_id'=>$post['user_id']))->save(array('is_default'=>'0'));
      }
      if($_POST['type'] == 'add'){
        $res = M('user_address')->add($post);
        if($res){
          json(200,'添加地址成功','');
        }
      }else if($_POST['type'] == 'save'){
        M('user_address')->where(array('address_id'=>$_POST['address_id']))->save($post);
        json(200,'修改地址成功','');
      }else if($_POST['type'] == 'del'){
        M('user_address')->where(array('address_id'=>$_POST['address_id']))->delete();
        json(200,'删除地址成功','');
      }
      
    }

    //收藏夹
    function select_collect(){
      $res = M('goods_collect')->where(array('user_id'=>$_POST['user_id']))->select();
      foreach ($res as $key => $value) {
        # code...
        $goods = M('goods')->where(array('goods_id'=>$value['goods_id']))->field('goods_name,shop_price,market_price')->find();
        $img = M('goods_images')->where(array('goods_id'=>$value['goods_id']))->find();
        $goods['img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$img['image_url'];
        $arr[] = array_merge($value,$goods);

      }
      json(200,'返回成功',$arr);
    }

    //删除收藏夹
    function del_collect(){
      $json = json_decode($_POST['json'],true);

      foreach ($json as $key => $value) {
        # code...
        M('goods_collect')->where(array('collect_id'=>$value['collect_id']))->delete();
      }
      json(200,'删除成功','');
    }

    //关注的店铺
    function follow_store(){
      $res = M('follow_store')->where(array('user_id'=>$_POST['user_id']))->select();
      foreach ($res as $key => $value) {
        # code...
        $store = M('user_store')->where(array('id'=>$value['store_id']))->field('store_name,store_img')->find();
        $store['store_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$store['store_img'];
        $arr[] = array_merge($value,$store);

      }
      json(200,'返回成功',$arr);
    }

    //返回地址
    function dizhi(){
      $res = M('region')->where(array('parent_id'=>$_POST['parent_id']))->select();
      json(200,'返回成功',$res);
    }

    //用户地址列表
    function user_address(){
      $res = M('user_address')->where(array('user_id'=>$_POST['user_id']))->select();
      foreach ($res as $key => $value) {
        # code...
        $province = M('region')->where(array('id'=>$value['province']))->field('name')->find();
        $city = M('region')->where(array('id'=>$value['city']))->field('name')->find();
        $district = M('region')->where(array('id'=>$value['district']))->field('name')->find();
        $twon = M('region')->where(array('id'=>$value['twon']))->field('name')->find();
        $value['province_name'] = $province['name'];
        $value['city_name'] = $city['name'];
        $value['district_name'] = $district['name'];
        $value['twon_name'] = $twon['name'];
        $arr[] = $value;
      }
      json(200,'返回成功',$arr);
    }

    //优惠卷
    function coupon(){
      $post = array(
          'uid'=>I('post.user_id'),
          'status'=>I('post.status')
        );

      $res = M('coupon_list')->where($post)->field('status,cid')->select();
      foreach ($res as $key => $value) {
        $cou = M('coupon')->where(array('id'=>$value['cid']))->field('name,money,condition,use_start_time,use_end_time')->find();
        $arr[] = array_merge($value,$cou);
      }
      json(200,'返回成功',$arr);
    }

    //我的订单
    function my_order(){
      $user_id = I('post.user_id');
      if(empty($user_id)){
        json(201,'用户不存在','');
      }

      if($_POST['type'] == 1){//待付款
        $where = array('user_id'=>$user_id,'pay_status'=>'0');
      }else if($_POST['type'] == 2){//代发货
        $where = array('user_id'=>$user_id,'pay_status'=>'1','shipping_status'=>'0');
      }else if($_POST['type'] == 3){//代收货
        $where = array('user_id'=>$user_id,'pay_status'=>'1','shipping_status'=>'1');
      }else if($_POST['type'] == 4){//待评价
        $where = array('user_id'=>$user_id,'pay_status'=>'1','shipping_status'=>'2','pingjia'=>'0');
      }else if($_POST['type'] == 5){//已完成
        $where = array('user_id'=>$user_id,'pay_status'=>'1','shipping_status'=>'2','pingjia'=>'1');
      }

      $order = M('order')->where($where)->limit($_POST['page'],$_POST['number'])->field('order_id,store_id')->select();

      foreach ($order as $key => $value) {
        # code...
        $goods = M('order_goods')->where(array('order_id'=>$value['order_id']))->field('rec_id,goods_id,goods_name,market_price,goods_price,member_goods_price,spec_key,spec_key_name,goods_num')->select();
        foreach ($goods as $k => $v) {
          # code...
          $zu = explode('_',$v['spec_key']);
          foreach ($zu as $kk => $vv) {
            # code...
            $img = M('spec_image')->where(array('spec_image_id'=>$vv,'goods_id'=>$v['goods_id']))->find();
            if($img){
              $v['img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$img['src'];
              break;
            }else{
              $v['img'] = '';
            }
          }
          $arr[] = array_merge($v,$value);
        }
        
      }
      json(200,'返回成功',$arr);
    }

    //取消订单
    function dell_order(){
      if(M('order')->where(array('order_id'=>$_POST['order_id']))->delete()){
        M('order_goods')->where(array('order_id'=>$_POST['order_id']))->delete();
        json(200,'取消成功','');
      }
      json(201,'取消失败','');
    }

    //确认收货
    function yes_shipping_status(){
      $order = M('order')->where(array('order_id'=>$_POST['order_id']))->save(array('shipping_status'=>'2'));
      if($order){
        json(200,'收货成功','');
      }
    }

    //评价
    function add_comment(){
      if($_FILES){
          $upload = new \Think\Upload();// 实例化上传类
            
            $upload->maxSize   =     3145728 ;// 设置附件上传大小
            $upload->exts      =     array('jpg', 'gif', 'png', 'jpeg');// 设置附件上传类型
            $upload->rootPath  =     './public/upload/'; // 设置附件上传根目录
            $upload->savePath  =     '/goods_comment/'; // 设置附件上传（子）目录
            // 上传文件 
            $info   =   $upload->upload();
            // echo json_encode($info);die;
            if(!$info) {// 上传错误提示错误信息
                   // json(401,$upload->getError(),'');
                    // $this->error($upload->getError());
            }else{// 上传成功
                    // $this->success('上传成功！');
                    foreach($info as $file){  
                        // echo json_encode($file);die;
                    $touxiang = $file['savepath'].$file['savename'];//头像路径
                }
                foreach ($info as $key => $value) {
                  # code...
                    $img .=  '/public/upload'.$value['savepath'].$value['savename'].',';
                  
                }
            }
          $img = substr($img, 0, -1);
        }
        
      if(isset($img)){
        $is_img = 1;
      }else{
        $img = '';
        $is_img = 0;
      }
      $post = array(
          'goods_id'=>$_POST['goods_id'],
          'username'=>$_POST['username'],
          'content'=>$_POST['content'],
          'add_time'=>time(),
          'user_id'=>$_POST['user_id'],
          'img'=>$img,
          'order_id'=>$_POST['order_id'],
          'deliver_rank'=>$_POST['deliver_rank'],
          'goods_rank'=>$_POST['goods_rank'],
          'service_rank'=>$_POST['service_rank'],
          'order_goods_id'=>$_POST['rec_id'],
          'is_img'=>$is_img,
          'store_id'=>$_POST['store_id'],
          'ping'=>$_POST['ping']
        );
      $add = M('comment')->add($post);
      if($add){
        $up_goods = M('order_goods')->where(array('rec_id'=>$_POST['rec_id']))->save(array('is_comment'=>'1'));
        $up_order = M('order')->where(array('order_id'=>$_POST['order_id']))->save(array('pingjia'=>'1'));
        json(200,'评价成功','');
      }
    }


    //删除购物车
    function del_cart(){
      $id = json_decode($_POST['json'],true);
      foreach ($id as $key => $value) {
        # code...
        M('cart')->where(array('id'=>$value))->delete();
      }
      json(200,'删除成功','');
    }

    //积分商城
    function integral(){
      $res = M('integral_goods')->where(array('up'=>'1'))->limit($_POST['page'],$_POST['number'])->select();
      foreach ($res as $key => $value) {
        # code...
        $value['src'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['src'];
        $arr[] = $value;
      }
      // foreach ($res as $key => $value) {
      //   # code...
      //   $value['image'] = M('integral_goods_image')->where(array('goods_id'=>$value['id']))->select();
      //   $arr[] = $value;
      // }
      json(200,'返回成功',$arr);
    }

    //积分商品详情
    function info_integral(){
      $res = M('integral_goods')->where(array('id'=>$_POST['goods_id']))->select();
      foreach ($res as $key => $value) {
        # code...
        if(!empty($value['src'])){
        $value['src'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['src'];

      }else{
        $value['src'] = '';
      }
      if(!empty($value['img'])){
        $value['img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['img'];

      }else{
        $value['img'] = '';
      }

        $image = M('integral_goods_image')->where(array('goods_id'=>$value['id']))->select();
        foreach ($image as $k => $v) {
          # code...
          $v['image'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$v['image'];
          $value['image'][] = $v;
        }
        $arr[] = $value;
      }

      $goods_type = M('integral_spec_goods_price')->where(array('goods_id'=>$_POST['goods_id']))->field('key')->find();
      $acc = explode('_',$goods_type['key']);
      foreach ($acc as $key => $value) {
        # code...
        $rr= M('integral_spec_item')->where(array('id'=>$value))->field('spec_id')->find();
        $spec[] = $rr['spec_id'];
      }

      foreach ($spec as $key => $value) {
        # code...
        $sp[] = M('integral_spec')->where(array('id'=>$value))->field('id,name')->find();
        
        
      }
      foreach ($sp as $key => $value) {
          # code...
          $sp[$key]['spec_item'] = M('integral_spec_item')->where(array('spec_id'=>$value['id']))->select();
        }

        foreach ($arr as $key => $value) {
          # code...
          $arr[$key]['item'] = $sp;
          // $$value;
        }
        // $arr['item'] = $sp;
      json(200,'返回成功',$arr);
    }


    //选择属性返回积分商品价格库存
    function return_integral_spec(){
      $key = $_POST['key'];
      $res = M('integral_spec_goods_price')->where(array('key'=>$key,'goods_id'=>$_POST['goods_id']))->find();

      json(200,'成功',$res);
    }

    //兑换商品
    function integral_pay(){
      if(empty($_POST['user_id'])){
        json(201,'用户没登录','');
      }
      $post = array(
          'goods_id'=>$_POST['goods_id'],
          'key'=>$_POST['key']
        );
      $goods = M('integral_spec_goods_price')->where($post)->find();
      if($_POST['number'] > $goods['store_count']){
        json(202,'库存不足','');
      }
      $jifen = $goods['price'] * $_POST['number'];
      $user = M('user')->where(array('user_id'=>$_POST['user_id']))->field('pay_points')->find();
      if($jifen > $user['pay_points']){
        json(203,'用户积分不够','');
      }
      if(M('users')->where(array('user_id'=>$_POST['user_id']))->setDec('pay_points',$jifen)){
        $arr = array(
          'sn'=>time(),
          'goods_id'=>$_POST['goods_id'],
          'key'=>$_POST['key'],
          'key_name'=>$goods['key_name'],
          'number'=>$_POST['number'],
          'time'=>time(),
          'integral'=>$jifen,
          'user_id'=>$_POST['user_id']
        );
        $add = M('integral_order')->add($arr);
        if($add){
          M('integral_spec_goods_price')->where(array('key'=>$_POST['key'],'goods_id'=>$_POST['goods_id']))->setDec('store_count',$_POST['number']);
          M('integral_goods')->where(array('goods_id'=>$_POST['goods_id']))->setDec('stock',$_POST['number']);
          M('integral_goods')->where(array('goods_id'=>$_POST['goods_id']))->setInc('number',$_POST['number']);
          json(200,'兑换成功','');
        }
      }
      json(400,'兑换失败','');
    }

    //兑换记录
    function integral_info(){
      if(empty($_POST['user_id'])){
        json(201,'用户没登录','');
      }
      $jilu = M('integral_order')->where(array('user_id'=>$_POST['user_id']))->select();
      foreach ($jilu as $key => $value) {
        # code...
        $goods = M('integral_goods')->where(array('id'=>$value['goods_id']))->find();
        $goods['img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$goods['img'];
        // foreach ($goods as $k => $valu) {
        //   // echo $valu['img'];
        //   # code...
        //   $goods[$k]['img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$valu['img'];
        // }
        $arr[] = array_merge($goods,$value);
      }
      json(200,'返回成功',$arr);
    }

    //我的界面
    function my(){
      $id = $_POST['user_id'];
      if(empty($id)){
        json(200,'用户不存在','');
      }
      $user = M('users')->where(array('user_id'=>$id))->field('pay_points,sex,head_pic,level,name')->find();
      $user['head_pic'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$user['head_pic'];
      $goods_collect = M('goods_collect')->where(array('user_id'=>$id))->select();
      foreach ($goods_collect as $key => $value) {
        # code...
        // $collect = $key + 1;
      }
      if($goods_collect){
        $user['goods_collect'] = $key + 1;
      }else{
        $user['goods_collect'] = 0;
      }
      

      $follow_store = M('follow_store')->where(array('user_id'=>$id))->select();
      foreach ($follow_store as $key => $value) {
        # code...
      }
      if($follow_store){
        $user['follow_store'] = $key + 1;
      }else{
        $user['follow_store'] = 0;
      }
      

      $coupon_list = M('coupon_list')->where(array('uid'=>$id))->select();
      foreach ($coupon_list as $key => $value) {
        # code...
      }
      if($coupon_list){
      $user['coupon_list'] = $key + 1;

    }else{
      $user['coupon_list'] = 0;

    }
      json(200,'返回成功',$user);
    
    }

    //积分商城
    function jifen_goods(){
      $res =  M('integral_goods')->where(array('up'=>'1'))->select();
      // var_dump($res);
      foreach ($res as $key => $value) {
        # code...
        $value['img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['img'];
        $arr[] = $value;
      }
      json(200,'返回成功',$arr);
    }

    //积分商品详情
    function info_jifen(){
      $res =  M('integral_goods')->where(array('id'=>$_POST['goods_id']))->find();
      // var_dump($res);
      // foreach ($res as $key => $value) {
        # code...
        $res['img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$res['img'];
        $img = M('integral_goods_image')->where(array('goods_id'=>$res['id']))->select();
        foreach ($img as $key => $value) {
          # code...
          $value['image'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['image'];
          $res['image'][] = $value;
        }
        // $arr[] = $value;
      // }
      json(200,'返回成功',$res);
    }

    //兑换商品
    function jifen_pay(){

      if(empty($_POST['user_id'])){
        json(201,'用户没登录','');
      }
      $post = array(
          'goods_id'=>$_POST['goods_id']
        );
      $goods = M('integral_goods')->where($post)->find();
      if($_POST['number'] > $goods['number']){
        json(202,'库存不足','');
      }
      $jifen = $goods['need_integral'] * $_POST['number'];
      $user = M('users')->where(array('user_id'=>$_POST['user_id']))->field('pay_points')->find();
      if($jifen > $user['pay_points']){
        json(203,'用户积分不够','');
      }
      if(M('users')->where(array('user_id'=>$_POST['user_id']))->setDec('pay_points',$jifen)){

        $arr = array(
          'sn'=>time(),
          'goods_id'=>$_POST['goods_id'],
          // 'key'=>$_POST['key'],
          // 'key_name'=>$goods['key_name'],
          'number'=>$_POST['number'],
          'time'=>time(),
          'integral'=>$jifen,
          'user_id'=>$_POST['user_id']
        );
        $add = M('integral_order')->add($arr);
        if($add){
          // M('integral_goods')->where(array('key'=>$_POST['key'],'goods_id'=>$_POST['goods_id']))->setDec('store_count',$_POST['number']);
          M('integral_goods')->where(array('goods_id'=>$_POST['goods_id']))->setDec('number',$_POST['number']);
          M('integral_goods')->where(array('goods_id'=>$_POST['goods_id']))->setInc('see',$_POST['number']);
          json(200,'兑换成功','');
        }
      }
      json(400,'兑换失败','');
    }

    //返回商品全部评价
    function all_comment(){
      if(empty($_POST['goods_id'])){
        json(201,'商品不存在','');
      }
      $id = $_POST['goods_id'];
      if($_POST['type'] == 1){
        $where = array(
            'goods_id'=>$id,
            'ping'=>'1'
          );
      }else if($_POST['type'] == 2){
          $where = array(
            'goods_id'=>$id,
            'ping'=>'2'
          );
      }else if($_POST['type'] == 3){
          $where = array(
            'goods_id'=>$id,
            'ping'=>'3'
          );
      }else if($_POST['type'] == 4){
          $where = array(
            'goods_id'=>$id,
            'is_img'=>'1'
          );
      }
      // var_dump($where);die;
      $comment = M('comment')->where($where)->field('order_goods_id,content,user_id')->select();
      $hao = M('comment')->where(array('goods_id'=>$id,'ping'=>'1'))->field('order_goods_id,content,user_id,is_img,img')->select();
      foreach ($hao as $k1 => $v1) {
        # code...
      }
      $zhong = M('comment')->where(array('goods_id'=>$id,'ping'=>'2'))->field('order_goods_id,content,user_id,is_img,img')->select();
      foreach ($zhong as $k2 => $v2) {
        # code...
      }
      $cha = M('comment')->where(array('goods_id'=>$id,'ping'=>'3'))->field('order_goods_id,content,user_id,is_img,img')->select();
      foreach ($cha as $k3 => $v3) {
        # code...
      }
      $tu = M('comment')->where(array('goods_id'=>$id,'is_img'=>'1'))->field('order_goods_id,content,user_id,is_img,img')->select();
      foreach ($tu as $k4 => $v4) {
        # code...
      }
      $quan = M('comment')->where(array('goods_id'=>$id))->field('order_goods_id,content,user_id,is_img,img')->select();
      foreach ($quan as $k5 => $v5) {
        # code...
      }
      // var_dump($comment);die;
      foreach ($comment as $key => $value) {
        # code...
        $order_goods = M('order_goods')->where(array('rec_id'=>$value['order_goods_id']))->field('spec_key_name')->find();
        $value['spec_key_name'] = $order_goods['spec_key_name'];
        $user = M('users')->where(array('user_id'=>$value['user_id']))->field('head_pic,name')->find();
        $value['touxiang'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$user['head_pic'];
        $value['user_name'] = $user['name'];

        if($value['is_img'] == 1){
          $img = explode(',',$value['img']);
          // var_dump($img);
          foreach ($img as $k => $v) {
            # code...
            $imag[] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$v;
          }
          $value['image'] = $imag;
        }else{
          $value['image'] = array();

        }
        
        $user_info[] = $value;
      }
      if(empty($user_info)){
        $user_info = array();
      }
      if($hao){
        $shu = $k1 + 1;
      }else{
        $shu = 0;
      }
      $aa['haha'] = $user_info;
      $aa['hao'] = $shu;

      if($zhong){
        $shu = $k2 + 1;
      }else{
        $shu = 0;
      }
      $aa['zhong'] = $shu;

      if($cha){
        $shu = $k3 + 1;
      }else{
        $shu = 0;
      }
      $aa['cha'] = $shu;

      if($tu){
        $shu = $k4 + 1;
      }else{
        $shu = 0;
      }
      $aa['tu'] = $shu;

      if($quan){
        $shu = $k5 + 1;
      }else{
        $shu = 0;
      }
      $aa['quan'] = $shu;
      json(200,'返回成功',$aa);
    }

    //系统设置 意见反馈
    function add_feedback(){
        for ($i=1; $i < 10; $i++) { 
            if(!empty($_FILES['image'.$i])){
                $_FILES['image'][] = $_FILES['image'.$i];
            }else{
                break;
            }
            // $i++;
        }
        // echo json_encode($_FILES);die;
        foreach ($_FILES['image'] as $k => $v) {
            # code...
        
        if(!empty($_FILES['image'.$k]['tmp_name'])){
            $upload = new \Think\Upload();// 实例化上传类
            $upload->maxSize   =     3145728 ;// 设置附件上传大小
            $upload->exts      =     array('jpg', 'gif', 'png', 'jpeg');// 设置附件上传类型
            $upload->rootPath  =     './public/upload/'; // 设置附件上传根目录
            $upload->savePath  =     '/feedback/'; // 设置附件上传（子）目录
            // 上传文件 
            $info   =   $upload->upload();
            if(!$info) {// 上传错误提示错误信息
                    // $this->json(401,$upload->getError(),'');
                // $touxiang = '';die;
                    // die;
                    // $this->error($upload->getError());
              // $touxiang[] = $upload->getError();//头像路径
            }else{// 上传成功
                    // $this->success('上传成功！');
                    foreach($info as $file){  
                        // echo json_encode($file);die;
                    $touxiang[] = '/Uploads/feedback'.$file['savepath'].$file['savename'];//头像路径
                }
            }
        }else{
            // $this->json(400,'没有上传头像','');
        }
    }
    // echo json_encode($touxiang);die;
        $post = array(
                'user_id'=>I('post.user_id'),
                'feedback'=>I('post.feedback'),
                'phone'=>I('post.phone')
                // 'img_url'=>$touxiang
            );
        $post = array_filter($post);
        $add = M('feedback')->add($post);
        
        if($add){
            if($touxiang){
                foreach ($touxiang as $key => $value) {
                    # code...
                    M('feedback_img')->add(array('img_url'=>$value,'feedback_id'=>$add));
                }
            }
            // M('user_log')->add(array('user_id'=>I('post.user_id'),'log_info'=>'提交了意见反馈','time'=>time()));
            json(200,'提交反馈成功','');
        }else{
            json(400,'提交反馈失败','');
        }
    }

    //返回可用的优惠卷
    function return_coupon(){
      $goods = M('goods')->where(array('goods_id'=>$_POST['goods_id']))->find();
      if($goods['prom_type'] == 0){
        $price = M('spec_goods_price')->where(array('key'=>$_POST['key'],'goods_id'=>$_POST['goods_id']))->find();
        $price['price'] = $price['price'] * $_POST['number'];
        $coupon = M('coupon')->where('condition <='.$price['price'])->where('use_start_time <='.time())->where('use_end_time >='.time())->field('id')->select();
        // echo json_encode($coupon);die;
        foreach ($coupon as $key => $value) {
          # code...
          // echo $value['id'];
          $arr[] = M('coupon_list')->where(array('cid'=>$value['id'],'uid'=>$_POST['user_id'],'status'=>'0'))->field('id,cid')->select();
        }
        foreach ($arr as $key => $value) {
          # code...
          // echo json_encode($value);die;
          if(!empty($value)){
            foreach ($value as $k => $v) {
              # code...
              $cou = M('coupon')->where(array('id'=>$v['cid']))->field('name,money,condition,use_start_time,use_end_time')->find();
              $acc[] = array_merge($v,$cou);
            }
          }
        }
              // echo json_encode($acc);die;
        json(200,'返回成功',$acc);
      }
        json(200,'返回成功','');

    }

    //修改个人资料
    function up_user(){
      if(!$_POST['user_id']){
        json(400,'用户不存在','');
      }
      if($_FILES){
          $upload = new \Think\Upload();// 实例化上传类
            
            $upload->maxSize   =     3145728 ;// 设置附件上传大小
            $upload->exts      =     array('jpg', 'gif', 'png', 'jpeg');// 设置附件上传类型
            $upload->rootPath  =     './public/upload/'; // 设置附件上传根目录
            $upload->savePath  =     '/goods_comment/'; // 设置附件上传（子）目录
            // 上传文件 
            $info   =   $upload->upload();
            // echo json_encode($info);die;
            if(!$info) {// 上传错误提示错误信息
                   // json(401,$upload->getError(),'');
                    // $this->error($upload->getError());
              $img =  '';
            }else{// 上传成功
                    // $this->success('上传成功！');
                    foreach($info as $file){  
                        // echo json_encode($file);die;
                    $touxiang = $file['savepath'].$file['savename'];//头像路径
                }
                foreach ($info as $key => $value) {
                  # code...
                    $img =  '/public/upload'.$value['savepath'].$value['savename'];
                  
                }
            }
        }

        $array = array(
            'name'=>$_POST['name'],
            'sex'=>$_POST['sex'],
            'head_pic'=>$img
          );
        $arr = array_filter($array);
        // echo json_encode($arr);die;
        $up = M('users')->where(array('user_id'=>$_POST['user_id']))->save($arr);
        $user = M('users')->where(array('user_id'=>$_POST['user_id']))->field('head_pic')->find();
        $user['head_pic'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$user['head_pic'];
        json(200,'修改成功',$user);
      }

      //搜索
      function search(){
        $name = $_POST['name'];
        if($_POST['type'] == 1){//商品
          $where['goods_name'] = array('like',"%$name%");
          $pro = M('goods')->where($where)->limit($_POST['page'],$_POST['number'])->field('goods_id,goods_name,shop_price,goods_remark,original_img')->select();
            foreach ($pro as $key => $value) {
            # code...
            if(!empty($value['original_img'])){
            $value['original_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['original_img'];

            }
            $arr[] = $value;
          }
        }else{//店铺
          $where['store_name'] = array('like',"%$name%");
          $pro = M('user_store')->where($where)->limit($_POST['page'],$_POST['number'])->field('id,admin_id,store_name,store_img,follow')->select();
          foreach ($pro as $key => $value) {
            # code...
            if(!empty($value['store_img'])){
            $value['store_img'] = 'http://'.$_SERVER['HTTP_HOST'].__ROOT__.$value['store_img'];
          }
            $arr[] = $value;
          }
        }
        
        
        json(200,'返回成功',$arr);
      }

      //忘记密码
      function up_password(){
        $_SESSION['code'] = '1234';
        if($_POST['code'] != $_SESSION['code']){
          json(201,'验证码错误','');
        }
        $post = array(
            'id'=>$_POST['user_id'],
            'password'=>md5($_POST['password'])
          );
         $up = M('users')->where(array('id'=>$post['id']))->save($post);
         // if($up){
          json(200,'修改密码成功','');
         // }
      }

}